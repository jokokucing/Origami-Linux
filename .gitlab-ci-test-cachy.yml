include:
  - local: .gitlab-ci-common.yml
stages:
  - build
  - iso
build-test-image-cachy:
  extends: .bluebuild-job-template
  stage: build
  script:
    - bluebuild build --verbose --compression-format zstd --push ./recipes/recipe-test-cachy.yml
build-test-cachy-iso:
  extends: .bluebuild-job-template
  stage: iso
  image: fedora:43

  # 1. RESTORED VARIABLES (Required for this specific job)
  variables:
    ISO_NAME: "origami-test-cachy-x86_64.iso"
    IMAGE_NAME: "registry.gitlab.com/origami-linux/images/origami-test"
    IMAGE_TAG: "br-test-cachy-43"

  before_script:
    - echo "Installing build dependencies..."
    - dnf install -y docker just git wget awscli2 sudo which

    # Fake Podman Wrapper
    - echo '#!/bin/bash' > /usr/bin/podman
    - echo 'docker "$@"' >> /usr/bin/podman
    - chmod +x /usr/bin/podman

    # Run template setup
    - !reference [.bluebuild-job-template, before_script]

  script:
    - git clone https://github.com/ublue-os/titanoboa.git

    # 2. FIXED PATH LOGIC
    # Check if the flatpak list exists. If not, pass "none" to Titanoboa.
    - |
      if [ -f "$CI_PROJECT_DIR/flatpaks/system-flatpaks.list" ]; then
        echo "Flatpaks list found."
        export ABS_FLATPAK_LIST="$CI_PROJECT_DIR/flatpaks/system-flatpaks.list"
      else
        echo "WARNING: flatpaks/system-flatpaks.list not found. Building without extra flatpaks."
        export ABS_FLATPAK_LIST="none"
      fi

    - export ABS_POST_SCRIPT="$CI_PROJECT_DIR/files/scripts/origami-iso.sh"
    - export BUILD_IMAGE="$IMAGE_NAME:$IMAGE_TAG"

    # Sanity Check: Ensure image name is valid
    - if [ "$BUILD_IMAGE" == ":" ]; then echo "Error: Variables IMAGE_NAME/TAG are missing!"; exit 1; fi

    - cd titanoboa
    - echo "Building ISO for $BUILD_IMAGE..."

    # 3. RUN BUILD
    - |
      HOOK_post_rootfs="$ABS_POST_SCRIPT" \
      sudo -E just build "$BUILD_IMAGE" \
        1 \
        "$ABS_FLATPAK_LIST" \
        squashfs \
        ""

    # Move output
    - mv *.iso "$CI_PROJECT_DIR/$ISO_NAME"

    # Checksum & Upload
    - cd "$CI_PROJECT_DIR"
    - sha256sum "$ISO_NAME" | tee "${ISO_NAME}-CHECKSUM"
    - export AWS_ACCESS_KEY_ID=$S3_ACCESS_KEY
    - export AWS_SECRET_ACCESS_KEY=$S3_SECRET_KEY
    - aws s3 cp "$ISO_NAME" s3://origami-linux/$ISO_NAME --endpoint-url $S3_ENDPOINT_URL
    - aws s3 cp "${ISO_NAME}-CHECKSUM" s3://origami-linux/${ISO_NAME}-CHECKSUM --endpoint-url $S3_ENDPOINT_URL
