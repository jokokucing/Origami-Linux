include:
  - local: .gitlab-ci-common.yml
stages:
  - build
  - iso
build-test-image-cachy:
  extends: .bluebuild-job-template
  stage: build
  script:
    - bluebuild build --verbose --compression-format zstd --push ./recipes/recipe-test-cachy.yml
build-test-cachy-iso:
  extends: .bluebuild-job-template
  stage: iso
  image: fedora:41

  variables:
    ISO_NAME: "origami-test-cachy-x86_64.iso"
    IMAGE_NAME: "registry.gitlab.com/origami-linux/images/origami-test"
    IMAGE_TAG: "br-test-cachy-43"

  before_script:
    # 1. Install dependencies (Added 'which' to fix the installer crash)
    - echo "Installing build dependencies..."
    - dnf install -y docker just git wget awscli2 sudo which

    # 2. Setup Podman Wrapper
    - echo '#!/bin/bash' > /usr/bin/podman
    - echo 'docker "$@"' >> /usr/bin/podman
    - chmod +x /usr/bin/podman

    # 3. Run template setup (Docker login & secure files)
    - !reference [.bluebuild-job-template, before_script]

  script:
    # We use a single block scalar (|) to avoid YAML syntax errors with complex logic
    - |
      set -e # Fail on first error

      echo "Cloning Titanoboa..."
      git clone https://github.com/ublue-os/titanoboa.git

      # --- PATH SAFETY CHECKS ---
      # 1. Flatpaks: Pass 'none' if file is missing (Prevents 'canonicalize' error)
      if [ -f "$CI_PROJECT_DIR/flatpaks/system-flatpaks.list" ]; then
        echo "‚úÖ Flatpaks list found."
        export ABS_FLATPAK_LIST="$CI_PROJECT_DIR/flatpaks/system-flatpaks.list"
      else
        echo "‚ö†Ô∏è Flatpaks list not found. Building without extra flatpaks."
        export ABS_FLATPAK_LIST="none"
      fi

      # 2. Post-Process Script
      export ABS_POST_SCRIPT="$CI_PROJECT_DIR/files/scripts/origami-iso.sh"
      if [ ! -f "$ABS_POST_SCRIPT" ]; then
        echo "‚ùå Error: Script not found at $ABS_POST_SCRIPT"
        exit 1
      fi

      # 3. Image Name Check
      export BUILD_IMAGE="$IMAGE_NAME:$IMAGE_TAG"
      if [[ "$BUILD_IMAGE" == ":" ]]; then
        echo "‚ùå Error: IMAGE_NAME or IMAGE_TAG is missing."
        exit 1
      fi

      # --- BUILD EXECUTION ---
      cd titanoboa
      echo "üöÄ Building ISO for $BUILD_IMAGE..."

      # We pass the script via env var, and 'just' handles the build
      HOOK_post_rootfs="$ABS_POST_SCRIPT" \
      sudo -E just build "$BUILD_IMAGE" \
        1 \
        "$ABS_FLATPAK_LIST" \
        squashfs \
        ""

      # --- UPLOAD ---
      echo "üì¶ Processing Output..."
      cd "$CI_PROJECT_DIR"
      # Rename the output file (Titanoboa usually names it deploy.iso or similar)
      mv *.iso "$ISO_NAME"

      echo "checksumming $ISO_NAME..."
      sha256sum "$ISO_NAME" | tee "${ISO_NAME}-CHECKSUM"

      echo "‚òÅÔ∏è Uploading to S3..."
      export AWS_ACCESS_KEY_ID=$S3_ACCESS_KEY
      export AWS_SECRET_ACCESS_KEY=$S3_SECRET_KEY
      aws s3 cp "$ISO_NAME" s3://origami-linux/$ISO_NAME --endpoint-url $S3_ENDPOINT_URL
      aws s3 cp "${ISO_NAME}-CHECKSUM" s3://origami-linux/${ISO_NAME}-CHECKSUM --endpoint-url $S3_ENDPOINT_URL
